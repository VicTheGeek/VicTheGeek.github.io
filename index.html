<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ó–∞–∫–∞–∑ –±–µ—Ç–æ–Ω–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f9f9fb; color: #333; padding: 20px; line-height: 1.6; }
    h2 { text-align: center; color: #4a4a7d; margin-bottom: 24px; font-weight: 600; }
    .tabs { display: flex; gap: 8px; margin: 0 auto 16px; max-width: 500px; }
    .tab { flex: 1; text-align: center; padding: 10px 12px; border-radius: 8px; cursor: pointer; background: #ececff; color: #333; font-weight: 600; }
    .tab.active { background: #7c7ce7; color: #fff; }
    .panel { display: none; }
    .panel.active { display: block; }
    form { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); max-width: 500px; margin: 0 auto; }
    input, select { width: 100%; padding: 12px 14px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; transition: border 0.3s ease, box-shadow 0.3s ease; }
    input:focus, select:focus { outline: none; border-color: #7c7ce7; box-shadow: 0 0 0 2px rgba(124, 124, 231, 0.2); }
    input::placeholder { color: #aaa; }
    button { width: 100%; padding: 14px; background-color: #7c7ce7; color: white; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s ease; margin-top: 10px; }
    button:hover { background-color: #6a6ad9; }
    button:active { background-color: #5a5acb; }
    .form-row { display: flex; gap: 12px; }
    .form-row input { flex: 1; }
    .orders { max-width: 500px; margin: 0 auto; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .order-item { padding: 10px 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .order-item:last-child { border-bottom: none; }
    .order-item:hover { background: #f7f7ff; }
    .order-details { margin-top: 12px; padding: 10px; background: #f7f7ff; border-radius: 8px; }
    .btn-cancel { border: none; background: #ffe6e6; color: #b30000; padding: 6px 10px; border-radius: 6px; font-weight: 700; cursor: pointer; }
    .btn-cancel:hover { background: #ffd6d6; }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab" id="tabNew">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</div>
    <div class="tab" id="tabOrders">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
  </div>

  <div class="panel" id="panelNew">
    <h2>–§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞</h2>
    <form id="orderForm">
      <input name="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç" placeholder="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç" required />
      <input name="–¢–µ–ª–µ—Ñ–æ–Ω" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω" type="tel" inputmode="numeric" pattern="[0-9]+" required />
      <div class="form-row">
        <input name="–î–∞—Ç–∞" type="date" required />
        <input name="–í—Ä–µ–º—è" type="time" placeholder="–í—Ä–µ–º—è" />
      </div>
      <select name="–ö–ª–∞—Å—Å –±–µ—Ç–æ–Ω–∞/–º–∞—Ä–∫–∞ —Ä-—Ä–∞" required>
        <option value="" disabled selected>–ö–ª–∞—Å—Å –±–µ—Ç–æ–Ω–∞/–º–∞—Ä–∫–∞ —Ä-—Ä–∞</option>
        <option>—Ä-—Ä –ú100 48 —á</option><option>—Ä-—Ä –ú150 48 —á</option><option>—Ä-—Ä –ú100 24 —á</option><option>–í25</option>
        <option>—Ä-—Ä –ú100</option><option>–í20</option><option>–í15</option><option>–í30</option><option>–í7.5</option><option>–í22.5</option><option>–í40</option><option>–í12.5</option>
      </select>
      <select name="–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å, –º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å, –¥—É–±–ª—å, –∫—Ä—É–ø–Ω–æ—Å—Ç—å —â–µ–±–Ω—è">
        <option value="" disabled selected>–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å, –º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å –∏ –¥—Ä.</option>
        <option>F150W6</option><option>W6F100</option><option>–ü3</option><option>W4F75–ü4</option><option>W6F100–ü4</option><option>W4F75–ü4</option>
        <option>W6F75–ü4 —Å—Å–ø—Ü</option><option>W4 –ü3</option><option>W4 –ü4</option><option>W4F75–ü3 –ª–µ—Å—Ç–Ω–∏—Ü–∞</option><option>W4F75–ü3</option><option>W4</option><option>W6F100 –ü4</option><option>W6F75–ü4</option><option>W4F75 –ü3</option>
      </select>
      <select name="–°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ —Å–º–µ—Å–∏">
        <option value="" disabled selected>–°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ —Å–º–µ—Å–∏</option>
        <option>—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä</option><option>–∫—Ä–∞–Ω</option><option>—Å–∞–º–æ—Å–ª–∏–≤</option><option>–Ω–∞—Å–æ—Å</option>
      </select>
      <input name="–û–±—ä–µ–º, –º¬≥" type="number" step="0.01" min="0" placeholder="–û–±—ä–µ–º, –º¬≥" required />
      <input name="–ê–¥—Ä–µ—Å" placeholder="–ê–¥—Ä–µ—Å" />
      <input name="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" />
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </form>
  </div>

  <div class="panel" id="panelOrders">
    <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
    <div id="ordersList" class="orders"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    function switchTab(tab) {
      document.getElementById('tabNew').classList.toggle('active', tab === 'new');
      document.getElementById('panelNew').classList.toggle('active', tab === 'new');
      document.getElementById('tabOrders').classList.toggle('active', tab === 'orders');
      document.getElementById('panelOrders').classList.toggle('active', tab === 'orders');
    }

    const url = new URL(window.location.href);
    const tab = url.searchParams.get('tab') || 'new';
    switchTab(tab);

    // MainButton –≤–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑"
    function updateMainButton() {
      if (document.getElementById('panelNew').classList.contains('active')) {
        tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑');
        tg.MainButton.enable();
        tg.MainButton.show();
      } else {
        tg.MainButton.hide();
      }
    }
    updateMainButton();

    document.getElementById('tabNew').onclick = () => { switchTab('new'); updateMainButton(); };
    document.getElementById('tabOrders').onclick = () => { switchTab('orders'); updateMainButton(); };

    // –†–µ–Ω–¥–µ—Ä "–ú–æ–∏ –∑–∞–∫–∞–∑—ã" –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ orders (base64 JSON)
    const ordersParam = url.searchParams.get('orders');
    function b64utf8Decode(b64) {
      const norm = b64.replace(/-/g, '+').replace(/_/g, '/');
      const bin = atob(norm);
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      try {
        return new TextDecoder('utf-8').decode(bytes);
      } catch (e) {
        // Fallback –¥–ª—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        return decodeURIComponent(escape(bin));
      }
    }
    if (ordersParam) {
      try {
        const json = b64utf8Decode(ordersParam);
        const orders = JSON.parse(json);
        renderOrders(orders);
      } catch (e) {
        // ignore
      }
    } else if (tab === 'orders') {
      // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–ø—Ä–æ—Å–∏–º —É –±–æ—Ç–∞ –∏ –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
      const container = document.getElementById('ordersList');
      container.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–∫–∞–∑—ã... –°—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∏–∂–µ –≤ —á–∞—Ç–µ.';
      try {
        tg.sendData(JSON.stringify({ action: 'fetch_orders' }));
      } catch (e) {}
    }

    function renderOrders(orders) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '';
      if (!orders || !orders.length) {
        container.textContent = '–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        return;
      }
      orders.forEach(o => {
        const item = document.createElement('div');
        item.className = 'order-item';
        item.dataset.order = o.n;
        const title = document.createElement('div');
        title.textContent = `${o.n} ‚Äî ${o.c || ''} ‚Äî ${o.d || ''}`;
        title.onclick = () => toggleOrderDetails(item, o);
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-cancel';
        cancelBtn.textContent = 'üö´';
        cancelBtn.title = '–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑';
        cancelBtn.onclick = (ev) => { ev.stopPropagation(); cancelOrder(o.n, item); };
        item.appendChild(title);
        item.appendChild(cancelBtn);
        container.appendChild(item);
      });
    }

    function toggleOrderDetails(itemEl, o) {
      const next = itemEl.nextElementSibling;
      if (next && next.classList.contains('order-details') && next.dataset.order === o.n) {
        // –£–∂–µ –æ—Ç–∫—Ä—ã—Ç ‚Äî —Å–≤–µ—Ä–Ω—É—Ç—å
        next.remove();
        return;
      }
      // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞—Ç—å (–∏ –µ—Å–ª–∏ –ø–æ–¥ —ç—Ç–∏–º –ø—É–Ω–∫—Ç–æ–º –±—ã–ª–∞ –¥—Ä—É–≥–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –µ—ë)
      if (next && next.classList.contains('order-details')) {
        next.remove();
      }
      const box = document.createElement('div');
      box.className = 'order-details';
      box.dataset.order = o.n;
      const fields = [
        ['–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', o.n],
        ['–î–∞—Ç–∞/–í—Ä–µ–º—è', o.d],
        ['–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', o.c],
        ['–ê–¥—Ä–µ—Å', o.a],
        ['–ö–ª–∞—Å—Å –±–µ—Ç–æ–Ω–∞/–º–∞—Ä–∫–∞ —Ä-—Ä–∞', o.k],
        ['–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å, –º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å, –¥—É–±–ª—å, –∫—Ä—É–ø–Ω–æ—Å—Ç—å —â–µ–±–Ω—è', o.p],
        ['–û–±—ä–µ–º, –º¬≥', o.v],
        ['–°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ —Å–º–µ—Å–∏', o.s],
        ['–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ', o.m],
      ];
      box.innerHTML = fields.map(([k,v]) => `<div style="margin:6px 0"><b>${k}:</b> ${v || ''}</div>`).join('');
      itemEl.parentNode.insertBefore(box, itemEl.nextSibling);
      box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MainButton –æ—Ç–¥–∞—ë—Ç—Å—è –Ω–∞ updateMainButton()
    updateMainButton();

    function collectData() {
      const form = document.getElementById('orderForm');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => { if (value !== undefined && value !== null) data[key] = String(value).trim(); });
      return data;
    }

    function validate() {
      const phone = document.querySelector('input[name="–¢–µ–ª–µ—Ñ–æ–Ω"]').value;
      if (!/^[0-9]+$/.test(phone)) { tg.showAlert && tg.showAlert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.'); return false; }
      const volume = document.querySelector('input[name="–û–±—ä–µ–º, –º¬≥"]').value;
      if (volume === '') { tg.showAlert && tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—ä—ë–º.'); return false; }
      return true;
    }

    function sendOrder() {
      if (!validate()) return;
      const data = collectData();
      try {
        tg.sendData(JSON.stringify(data));
        setTimeout(() => { try { tg.showAlert && tg.showAlert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); } catch(e) {} tg.close(); }, 200);
      } catch (e) {
        tg.showAlert && tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      }
    }

    function cancelOrder(orderNumber, itemEl) {
      const ok = window.confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ ${orderNumber}?`);
      if (!ok) return;
      try {
        tg.sendData(JSON.stringify({ action: 'cancel', order: orderNumber }));
        // –û–±–Ω–æ–≤–∏–º UI: —Å–Ω–∏–º–µ–º –∫–Ω–æ–ø–∫—É –∏ –æ—Ç–º–µ—Ç–∏–º –∫–∞–∫ –æ—Ç–º–µ–Ω—ë–Ω
        const note = document.createElement('div');
        note.className = 'order-details';
        note.dataset.order = orderNumber;
        note.innerHTML = `<div style="color:#b30000"><b>–ó–∞–∫–∞–∑ ${orderNumber} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –æ—Ç–º–µ–Ω—ë–Ω. –ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏ ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.</b></div>`;
        // –£–¥–∞–ª–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞–Ω–µ–ª—å –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å
        const next = itemEl.nextElementSibling;
        if (next && next.classList.contains('order-details')) next.remove();
        itemEl.parentNode.insertBefore(note, itemEl.nextSibling);
        const btn = itemEl.querySelector('.btn-cancel');
        if (btn) btn.disabled = true;
      } catch (e) {}
    }

    document.getElementById('orderForm').addEventListener('submit', function (e) { e.preventDefault(); sendOrder(); });
    tg.onEvent('mainButtonClicked', sendOrder);
  </script>
</body>
</html>